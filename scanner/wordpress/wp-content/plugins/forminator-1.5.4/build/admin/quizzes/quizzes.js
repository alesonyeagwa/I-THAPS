!function(t){formintorjs.define(["admin/quizzes/knowledge/details-settings","admin/quizzes/knowledge/questions-settings","admin/quizzes/knowledge/settings-settings","admin/quizzes/knowledge/appearance-settings","admin/quizzes/no-wrong/details-settings","admin/quizzes/no-wrong/questions-settings","admin/quizzes/no-wrong/results-settings","admin/quizzes/no-wrong/appearance-settings","admin/popup/ajax","text!admin/templates/quizzes.html"],function(i,e,n,a,r,s,o,l,d,u){return Backbone.View.extend({currentTab:0,mainTpl:Forminator.Utils.template(t(u).find("#quiz-main-tpl").html()),buttonsTpl:Forminator.Utils.template(t(u).find("#quiz-buttons-tpl").html()),is_edit:!1,events:{"click .sui-vertical-tab a":"go_to_tab","click .forminator-save":"save_changes","click #forminator-polls-finish":"save_layout","click #forminator-polls-cancel":"cancel","click #forminator-polls-back":"prev_tab","click #forminator-polls-next":"next_tab","click .fui-button-preview":"open_preview","change input":"set_dirty"},initialize:function(t){return this.app=Forminator.Data.application||!1,this.render()},render:function(){var d={},u=Forminator.Data.currentForm.form_id||-1;this.is_edit=-1!==u,this.$el.html(this.mainTpl({type:this.app})),this.$el.append(this.buttonsTpl()),d="knowledge"===this.app?{details:i,questions:e,settings:n,appearance:a}:{details:r,questions:s,results:o,appearance:l};var f=this;t(window).off("beforeunload.forminator-leave-wizard-confirm"),t(window).on("beforeunload.forminator-leave-wizard-confirm",function(t){if(f.dirty)return Forminator.l10n.popup.save_alert}),this.init_tabs(),this.append_settings(d),this.update_buttons(),Forminator.Utils.sui_delegate_events(),this.$el.find("#forminator-quizwiz--title .sui-error-message").hide()},cancel:function(t){t.preventDefault(),window.location.href=Forminator.Data.modules.quizzes.form_list_url},save_changes:function(i){this.validate()?(this.save(!1,!0),t(".fui-button-preview").show()):t("html, body").animate({scrollTop:0},500)},save_layout:function(i){this.validate()?this.save(!0,!0):t("html, body").animate({scrollTop:0},500)},save:function(i,e){var n,a=this,r=Forminator.Utils.model_to_json(this.model),s=this.model.get("quiz_title")||"",o=Forminator.Data.currentForm.form_id||-1;e&&this.$el.find(".forminator-loading").addClass("sui-button-onload"),n="knowledge"===this.app?"forminator_save_quiz_knowledge":"forminator_save_quiz_nowrong",t.post({url:Forminator.Data.ajaxUrl,data:{action:n,_wpnonce:Forminator.Data.formNonce,formName:s,form_id:o,data:r}}).success(function(t){a.dirty=!1,-1===o&&(Forminator.Data.currentForm.form_id=t.data);var n;if(i?-1===o?(n=Forminator.Data.modules.quizzes.form_list_url,window.location.href=n+"&new=true&title="+s.replace(/ /g,"-")):(n=Forminator.Data.modules.quizzes.form_list_url,window.location.href=n+"&notification=true&title="+s.replace(/ /g,"-")):a.is_edit||Forminator.navigate(a.app+"/"+Forminator.Data.currentForm.form_id,{trigger:!1,replace:!0}),e&&(setTimeout(function(){a.$el.find(".forminator-loading").removeClass("sui-button-onload")},500),!i)){var r=_.template("<strong>{{ formName }}</strong> {{ Forminator.l10n.options.been_saved }}");Forminator.Notification.open("success",r({formName:s}),4e3)}}).error(function(){Forminator.Notification.open("error",Forminator.l10n.options.error_saving,5e3)})},append_settings:function(t){var i=this;_.each(t,function(t,e){var n=new t({model:i.model});i.$el.find("#forminator-quiz-"+e).append(n.el)})},update_buttons:function(){this.is_first_tab()?(this.$el.find("#forminator-polls-cancel").css("display","inline-flex"),this.$el.find("#forminator-polls-back").hide(),this.$el.find("#forminator-polls-next").css("display","inline-flex"),this.$el.find("#forminator-polls-finish").hide()):this.is_last_tab()?(this.$el.find("#forminator-polls-cancel").hide(),this.$el.find("#forminator-polls-back").css("display","inline-flex"),this.$el.find("#forminator-polls-next").hide(),this.$el.find("#forminator-polls-finish").css("display","inline-flex")):(this.$el.find("#forminator-polls-cancel").hide(),this.$el.find("#forminator-polls-back").css("display","inline-flex"),this.$el.find("#forminator-polls-next").css("display","inline-flex"),this.$el.find("#forminator-polls-finish").hide())},init_tabs:function(){this.update_tab()},update_tab:function(){this.clear_tabs(),this.$el.find("[data-tab-id="+this.currentTab+"]").addClass("current"),this.$el.find(".wpmudev-tab-content-"+this.currentTab).show()},clear_tabs:function(){this.$el.find(".sui-vertical-tab ").removeClass("current"),this.$el.find(".wpmudev-settings--box").hide()},is_first_tab:function(){return 0===this.currentTab},is_last_tab:function(){return this.currentTab===this.$el.find(".sui-vertical-tab").length-1},mark_tab:function(){this.$el.find("[data-tab-id="+this.currentTab+"]").addClass("done")},validate_quiz_title:function(){return _.isEmpty(this.model.get("quiz_title"))?(0!==this.currentTab&&(this.currentTab=0,this.update_tab(),this.update_buttons()),this.$el.find("#forminator-quizwiz--title").addClass("sui-form-field-error"),this.$el.find("#forminator-quizwiz--title .sui-error-message").show(),!1):(this.$el.find("#forminator-quizwiz--title").removeClass("sui-form-field-error"),this.$el.find("#forminator-quizwiz--title .sui-error-message").hide(),!0)},validate_quiz_questions:function(){return"knowledge"===this.app?this.validate_knowledge_questions():this.validate_nowrong_questions()},validate_nowrong_questions:function(){var t,i=this;this.$el.find(".forminator-validate-question").hide(),this.$el.find(".forminator-validate-answer-result").hide(),this.$el.find(".forminator-validate-correct-answer").hide();var e=this.model.get("questions");return _.isUndefined(e)||e.length<1?!(this.currentTab>=2)||(2!==this.currentTab&&(this.currentTab=2,this.update_tab(),this.update_buttons()),this.$el.find(".forminator-validate-question").show(),!1):(t=e.filter(function(t){return t.answers_count()<1||t.find_answers_with_no_result().length>0}),!(t.length>0)||(2!==this.currentTab&&(this.currentTab=2,this.update_tab(),this.update_buttons()),_.each(t,function(t){var n=e.model_index(t),a=i.$el.find(".fui-question[data-index="+n+"]");if(t.answers_count()<1)a.find(".forminator-validate-correct-answer p").html(Forminator.l10n.quizzes.validate_form_no_answer),a.find(".forminator-validate-correct-answer").show();else{var r=t.find_answers_with_no_result();_.each(r,function(i){var e=t.get("answers").model_index(i),n=a.find(".fui-answer[data-index="+e+"]");n.hasClass("fui-answer-open")||n.addClass("fui-answer-open"),n.find(".forminator-validate-answer-result[data-index="+e+"] p").html(Forminator.l10n.quizzes.validate_form_answers_result),n.find(".forminator-validate-answer-result[data-index="+e+"]").show()})}}),!1))},validate_knowledge_questions:function(){if(this.currentTab<1)return!0;var i,e=this;this.$el.find(".forminator-validate-question").hide(),this.$el.find(".forminator-validate-correct-answer").hide();var n=this.model.get("questions");return _.isUndefined(n)||n.length<1?(1!==this.currentTab&&(this.currentTab=1,this.update_tab(),this.update_buttons()),this.$el.find(".forminator-validate-question").show(),!1):n.filter(function(t){return _.isEmpty(t.get("title"))}).length>0?(1!==this.currentTab&&(this.currentTab=1,this.update_tab(),this.update_buttons()),this.$el.find(".forminator-validate-question").show(),!1):(i=n.filter(function(t){return t.answers_count()<1||!t.is_have_correct_answer()}),!(i.length>0)||(1!==this.currentTab&&(this.currentTab=1,this.update_tab(),this.update_buttons()),_.each(i,function(i){var a=n.model_index(i),r=e.$el.find(".fui-question[data-index="+a+"]"),s=Forminator.l10n.quizzes.validate_form_correct_answer;i.answers_count()<1&&(s=Forminator.l10n.quizzes.validate_form_no_answer),r.find(".forminator-validate-correct-answer p").html(s),r.find(".forminator-validate-correct-answer").show(),r.find(".fui-answer:not(.fui-answer-add-indicator)").each(function(){t(this).hasClass("fui-answer-open")||t(this).addClass("fui-answer-open")})}),!1))},validate_nowrong_results:function(){if(this.$el.find(".forminator-validate-quiz-results").hide(),this.currentTab<1)return!0;var t=this.model.get("results");return!(_.isUndefined(t)||t.length<1)||(this.$el.find(".forminator-validate-quiz-results").show(),1!==this.currentTab&&(this.currentTab=1,this.update_tab(),this.update_buttons()),!1)},validate:function(){return!!this.validate_quiz_title()&&(!("nowrong"===this.app&&!this.validate_nowrong_results())&&this.validate_quiz_questions())},go_to_tab:function(i){var e=t(i.target),n=e.data("tab-id");this.validate()?(this.currentTab=n,this.update_tab(),this.update_buttons()):this.$el.find("[data-tab-id="+this.currentTab+"]").removeClass("done"),i.preventDefault(),i.stopPropagation()},prev_tab:function(){this.currentTab=this.currentTab-1,this.update_tab(),this.update_buttons()},next_tab:function(){this.validate()?(this.mark_tab(),this.currentTab=this.currentTab+1,this.update_tab(),this.update_buttons(),this.save(!1,!0)):this.$el.find("[data-tab-id="+this.currentTab+"]").removeClass("done")},open_preview:function(i){i.preventDefault();var e=t(i.target);e.hasClass("fui-button-preview")||(e=e.closest(".fui-button-preview"));var n=e.data("modal"),a=e.data("nonce"),r=e.data("form-id"),s=void 0!==this.model.get("quiz_title")?" - "+this.model.get("quiz_title"):"";this.open_preview_popup(n,a,r,Forminator.l10n.popup.preview_quizzes+s,this.model.toJSON())},open_preview_popup:function(i,e,n,a,r){_.isUndefined(a)&&(a=Forminator.l10n.quizzes.preview_quiz),_.isUndefined(r.form_id)&&(r.form_id=Forminator.Data.currentForm.form_id);var s=new d({action:i,nonce:e,data:r,id:n});Forminator.Popup.open(function(){t(this).append(s.el)},{title:a,has_footer:!1,has_custom_box:!0})},set_dirty:function(){this.dirty=!0}})})}(jQuery);